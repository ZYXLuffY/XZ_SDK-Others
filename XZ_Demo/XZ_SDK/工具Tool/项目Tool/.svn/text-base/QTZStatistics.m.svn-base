
#import "QTZStatistics.h"
#import "UMMobClick/MobClick.h"
#import <objc/runtime.h>

#ifdef DEBUG
#define NSLog(fmt, ...) NSLog((@"" fmt), ##__VA_ARGS__)
#else
#define NSLog(...)
#endif

#pragma mark - ğŸ”µ ====== ====== å‹ç›Ÿç»Ÿè®¡ ====== ======  ğŸ”µ

@interface QTZStatistics ()
{
@public
    NSArray *QTZStructure_QiandaoSteps;/**< ç­¾åˆ°é¢†åˆ¸æ´»åŠ¨ åŒ…å«æ­¥éª¤ */
    NSArray *QTZStructure_RZXSZAct;/**< è®¤è¯è¡Œé©¶è¯æ´»åŠ¨ åŒ…å«æ­¥éª¤ */
    
    NSArray *QTZInvalidLogPageView;/**< ä¸éœ€è¦ç»Ÿè®¡çš„ é¡µé¢è®¿é—®æ—¶é•¿ */
}
@property (nonatomic,strong) NSArray *Arr_H5;/**< è¿›å…¥åŒ…å«ç»Ÿè®¡çš„H5é¡µé¢ å‹ç›Ÿç»Ÿè®¡äº‹ä»¶ID*/
@property (nonatomic,strong) NSArray *Arr_Native;/**< è¿›å…¥åŒ…å«ç»Ÿè®¡çš„åŸç”Ÿé¡µé¢ å‹ç›Ÿç»Ÿè®¡äº‹ä»¶ID*/

@end

@implementation  QTZStatistics

static QTZStatistics *instance;

+ (instancetype)share{
    static QTZStatistics *instance;
    static dispatch_once_t onceToken;
    
    dispatch_once(&onceToken, ^{
        instance = [[self alloc]init];
        
        //H5é¡µé¢  å‹ç›Ÿç»Ÿè®¡äº‹ä»¶ID
        instance.Arr_H5 =     @[@"insIntro",@"xiche",@"meirong",@"baoyang",@"weixiu",@"zhuanghuang",@"jiuyuan",@"appfaq"];
        
        
        //åŸç”Ÿé¡µé¢ å‹ç›Ÿç»Ÿè®¡äº‹ä»¶ID
        instance.Arr_Native = @[@"QTZgiftCardVC",@"BaoYang_TimeLineVC",@"BaoXianJiuYuanTVC",@"ContactUsVC",@"CarReportTVC",@"MyCarLocationVC",@"CleanFuckingCodeTVC",@"DriveRecordFootMarkVC",@"CarTestVC",@"Jiashi_UploadActivityVC",@"OBDVoiceMsgNotifyVC",@"FlowInChargeVC",@"QTZ_BuyOBDVC",@"CurrentCarConditionVC"];
        
        //ç»“æ„åŒ–äº‹ä»¶     index 0  æ˜¯å‹ç›Ÿçš„ç»Ÿè®¡ID
        instance -> QTZStructure_QiandaoSteps = @[@"ç­¾åˆ°é¢†åˆ¸æ´»åŠ¨",@"è¿›å…¥ç­¾åˆ°æ´»åŠ¨é¡µ",@"ç‚¹å‡»ç­¾åˆ°",@"ç­¾åˆ°_é¢†åˆ¸æˆåŠŸ",@"ç­¾åˆ°_ç‚¹å‡»åˆ†äº«",@"ç­¾åˆ°_åˆ†äº«æˆåŠŸ"];
        instance -> QTZStructure_RZXSZAct = @[@"è®¤è¯è¡Œé©¶è¯æ´»åŠ¨",@"è¿›å…¥è®¤è¯è¡Œé©¶è¯æ´»åŠ¨é¡µ",@"è¡Œé©¶è¯_ç‚¹å‡»æˆ‘è¦å‚ä¸",@"è¡Œé©¶è¯ä¸Šä¼ æˆåŠŸ"];
        
        //ä¸éœ€è¦ç»Ÿè®¡è®¿é—®æ—¶é•¿çš„é¡µé¢ æœ‰äº›æ˜¯ç‰¹æ®Šå¼¹å‡ºçš„ä»€ä¹ˆçš„
        instance -> QTZInvalidLogPageView = @[@"JEBaseNavtion",@"JETabbar_Controller",@"UIViewController",@"UIAlertController",@"UICompatibilityInputViewController",@"_UIRemoteInputViewController"];
    });
    
    return instance;
}

#pragma mark -  éƒ¨åˆ†æŒ‰é’®ç‚¹å‡»äº‹ä»¶

- (void)nativeBtnClick:(NSString*)Statistics{
    [MobClick event:Statistics];
    NSLog(@"H5ğŸ’šğŸ’šğŸ’šğŸ’šæŒ‰é’®ç‚¹å‡»æ‰“ç‚¹ç»Ÿè®¡ğŸ“ğŸ“ğŸ“ æˆ– åˆ†äº«%@",Statistics);
}

#pragma mark -  è¦è¿›å…¥H5é¡µé¢

- (void)H5Statistics:(NSString*)urlStr{
    NSLog(@"ğŸ’›ğŸ’›ğŸ’›ğŸ’›ğŸ’›ğŸ’›ğŸ’›ğŸ’›ğŸ’›%@",urlStr);
    for (NSString *Statistics in _Arr_H5) {
        if ([urlStr containsString:Statistics]) {
            [MobClick event:Statistics];
            NSLog(@"H5ğŸ’šğŸ’šğŸ’šğŸ’šæ‰“ç‚¹ç»Ÿè®¡ğŸ“ğŸ“ğŸ“%@",Statistics);
            break;
        }
    }
    
    //æ‰“å¼€çš„ç½‘é¡µ
    if ([urlStr rangeOfString:@"drivingLicense"].location != NSNotFound){
        [[QTZStatistics share] structureStatistics:QTZStructureStatisticsTypeDriveActivity step:2];//å‹ç›Ÿç»Ÿè®¡ 2 è¡Œé©¶è¯_ç‚¹å‡»æˆ‘è¦å‚ä¸
    }
    else if ([urlStr rangeOfString:@"authDriving"].location != NSNotFound){
        [[QTZStatistics share] structureStatistics:QTZStructureStatisticsTypeDriveActivity step:1];//å‹ç›Ÿç»Ÿè®¡ 1 è¿›å…¥è®¤è¯è¡Œé©¶è¯æ´»åŠ¨é¡µ
    }
    
    //  ç­¾åˆ°é¢†åˆ¸æ´»åŠ¨ step 1 - 5   1ã€‚è¿›å…¥ç­¾åˆ°æ´»åŠ¨é¡µ 	2ã€‚ç‚¹å‡»ç­¾åˆ°	  3ã€‚ç­¾åˆ°_é¢†åˆ¸æˆåŠŸ	  4ã€‚ç­¾åˆ°_ç‚¹å‡»åˆ†äº«     5ã€‚ç­¾åˆ°_åˆ†äº«æˆåŠŸ
    if ([urlStr rangeOfString:@"signInfo"].location != NSNotFound){
        [[QTZStatistics share] structureStatistics:QTZStructureStatisticsTypeQiandao step:1];//å‹ç›Ÿç»Ÿè®¡ 1 è¿›å…¥ç­¾åˆ°æ´»åŠ¨é¡µ
    }
    
    
    
}

#pragma mark - ç»“æ„åŒ–äº‹ä»¶ç»Ÿè®¡
/** å‹ç›Ÿ ç»“æ„åŒ–äº‹ä»¶ç»Ÿè®¡ æ¯è¿›è¡Œä¸€æ­¥ è°ƒä¸€æ¬¡ */
- (void)structureStatistics:(QTZStructureStatisticsType)type step:(NSUInteger)step{
    switch (type) {
        case QTZStructureStatisticsTypeQiandao:{/**< ç­¾åˆ°é¢†åˆ¸æ´»åŠ¨ */
            if (step >= QTZStructure_QiandaoSteps.count) { break;}
            [MobClick event:[QTZStructure_QiandaoSteps subarrayWithRange:NSMakeRange(0, step + 1)] value:1 label:nil];
        } break;
        case QTZStructureStatisticsTypeDriveActivity:{/**< è®¤è¯è¡Œé©¶è¯æ´»åŠ¨ */
            if (step >= QTZStructure_RZXSZAct.count) { break;}
            [MobClick event:[QTZStructure_RZXSZAct subarrayWithRange:NSMakeRange(0, step + 1)] value:1 label:nil];
        } break;
        default:
            break;
    }
}


@end

#pragma mark - ğŸ”µ ====== ====== ç»Ÿè®¡åŸç”Ÿé¡µé¢ ====== ======  ğŸ”µ

@implementation UIViewController (QTZ)

+ (void)load{
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        [self swizzleInstanceMethod:@selector(viewDidLoad) with:@selector(MobClick_viewDidLoad)];
        [self swizzleInstanceMethod:@selector(viewDidAppear:) with:@selector(MobClick_viewDidAppear:)];
        [self swizzleInstanceMethod:@selector(viewDidDisappear:) with:@selector(MobClick_viewDidDisappear:)];
    });
}

+ (BOOL)swizzleInstanceMethod:(SEL)originalSel with:(SEL)newSel {
    Method originalMethod = class_getInstanceMethod(self, originalSel);
    Method newMethod = class_getInstanceMethod(self, newSel);
    if (!originalMethod || !newMethod) return NO;
    
    class_addMethod(self,originalSel,class_getMethodImplementation(self, originalSel),method_getTypeEncoding(originalMethod));
    class_addMethod(self,newSel,class_getMethodImplementation(self, newSel), method_getTypeEncoding(newMethod));
    
    method_exchangeImplementations(class_getInstanceMethod(self, originalSel),class_getInstanceMethod(self, newSel));
    return YES;
}

/** ç”¨äºç»Ÿè®¡é¡µé¢å¼€å§‹æ—¶é—´ */
-(void)MobClick_viewDidAppear:(BOOL)animated{
    [self MobClick_viewDidAppear:YES];
    [self logPageViewInBegin:YES vcName:NSStringFromClass([self class])];//    NSLog(@"MobClick_viewDidAppearâœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸âœ¡ï¸%@",NSStringFromClass([self class]));
}

/** ==ç»“æŸæ—¶é—´== */
-(void)MobClick_viewDidDisappear:(BOOL)animated{
    [self MobClick_viewDidDisappear:YES];
    [self logPageViewInBegin:NO vcName:NSStringFromClass([self class])];//    NSLog(@"MobClick_viewDidDisappearğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸ğŸ…¾ï¸%@",NSStringFromClass([self class]));
}

- (void)logPageViewInBegin:(BOOL)isBegin vcName:(NSString*)vcName{
    if ([[QTZStatistics share] -> QTZInvalidLogPageView containsObject:vcName]) {
        return;
    }
    isBegin ? [MobClick beginLogPageView:vcName] : [MobClick endLogPageView:vcName];
}

-(void)MobClick_viewDidLoad{
    [self MobClick_viewDidLoad];
    NSString *Statistics   = NSStringFromClass([self class]);
    
    if ([[QTZStatistics share].Arr_Native containsObject:Statistics]) {//åŒ…å«è¦ç»Ÿè®¡çš„   ã€‹ã€‹ã€‹ã€‹ã€‹ã€‹è¿›å…¥çš„é¡µé¢ã€Šã€Šã€Šã€Šã€Šã€Š
        [MobClick event:Statistics];
        NSLog(@"åŸç”ŸğŸ’šğŸ’šğŸ’šğŸ’šæ‰“ç‚¹ç»Ÿè®¡ğŸ“ğŸ“ğŸ“%@",Statistics);
    }
}


@end
