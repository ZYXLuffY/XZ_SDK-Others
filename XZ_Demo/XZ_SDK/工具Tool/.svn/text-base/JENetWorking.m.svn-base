
#import "JENetWorking.h"
#import "AFNetworking.h"
#import "JEUtility.h"
#import "LoginVC.h"
#import "JEDebugTool__.h"
#import "QTZ_AlertView.h"
#import "Main_3_VC.h"

static BOOL         NetShowAct          = YES;/**< å¤´é¡¶ä¿¡æ¯æ ç›®çš„è½¬åœˆåœˆ */
static NSUInteger   AllNetOperations = 0;//æ‰€æœ‰è¯·æ±‚ä¸­çš„æ•°é‡ ä¸ºé›¶æ—¶ åœæ­¢è½¬åŠ¨
static BOOL         refreshingToken      = NO;/**< åˆ·æ–°tokenä¸­ */

@implementation JENetWorking

+(void)API:(NSString*)API Param:(NSDictionary*)param Vc:(UIViewController*)vc  AF:(AFHTTPSessionManager *)Manager Suc:(void(^)(NSDictionary *Res))Suc{
    [JENetWorking API:API Param:param Vc:vc AF:Manager Suc:Suc Fai:nil];
}

+(void)API:(NSString*)API Param:(NSDictionary*)param Vc:(UIViewController*)vc AF:(AFHTTPSessionManager *)Manager Suc:(void(^)(NSDictionary *Res))Suc Fai:(void(^)(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error))Fai{
    
    API = [NSString stringWithFormat:@"%@%@",BoJue_BASEHTTP,API];
    
    //#if 0       //DEBUGç¼“å­˜å…¨å¼€ å–æ¶ˆç½‘ç»œ
    //#ifdef DEBUG
    //    [JENetWorking HandleNetworkRes:[JEdb Get:@{@"API" : API,@"dic" : param}.JsonStr.MD5 Table:Table_DEBUG] Op:nil Param:param Vc:vc Suc:Suc];
    //#endif
    //    return;
    //#endif
    
    if (Manager == nil) {
        Manager = JEApp.window.rootViewController.AFM;
    }
    
    [Manager.requestSerializer setValue:[USDF stringForKey:UserDef_Tmbj_Token] ? : @"" forHTTPHeaderField:Tmbj_Token];//ä¿è¯æ¯æ¬¡åˆ·æ–°token
    
    if (NetShowAct) {[UIApplication sharedApplication].networkActivityIndicatorVisible = YES; AllNetOperations++;}
    
    [Manager POST:API parameters:param progress:nil success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
        if (NetShowAct) {if (!--AllNetOperations) { [UIApplication sharedApplication].networkActivityIndicatorVisible = NO;}}
        [vc.HUD removeFromSuperview];
        if (task.error.code == NSURLErrorCancelled) {
            return ;
        }
        
        //  ç™»å½• åˆ·æ–° æŽ¥å£ ç¼“å­˜@"tmbj-token" è´¦æˆ·é€€å‡ºçš„æ—¶å€™åˆ é™¤
        if ([API rangeOfString:API_login].location != NSNotFound || [API rangeOfString:API_weixinLogin].location != NSNotFound || [API rangeOfString:API_refreshToken].location != NSNotFound) {
            NSArray *cookies = [NSHTTPCookie cookiesWithResponseHeaderFields:[(NSHTTPURLResponse*)task.response allHeaderFields] forURL:[NSURL URLWithString:API]];
            for (NSHTTPCookie *cookie in cookies) {
                if ([cookie.name isEqualToString:Tmbj_Token]) {
                    [[JEDebugTool__ Shared] addDicLog:@{} Param:@{@"Tmbj_Token" : cookie.value} API:@"======  ç™»å½•èŽ·å¾—çš„Token  ======"];
                    [USDF setValue:cookie.value forKey:UserDef_Tmbj_Token];
                    [USDF removeObjectForKey:UserDef_refreshTokenTime];
                    [USDF synchronize];break;
                }
            }
        }
        
        NSDictionary *NetRes = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableContainers error:nil];
        [JENetWorking CreatePostUrl:API Param:param error:nil];//æ‰“å°ä¸‹è¯·æ±‚çš„å‚æ•°
        [JENetWorking HandleNetworkRes:NetRes Op:task Param:param Vc:vc Suc:Suc];
        
#if 1       //DEBUGç¼“å­˜
#ifdef DEBUG
        [[JEDebugTool__ Shared] addDicLog:NetRes Param:param API:API];
        //        [JEdb Save:NetRes Id:@{@"API" : API,@"dic" : param ? param : @{}}.JsonStr.MD5 Table:Table_DEBUG];
#endif
#endif
        
    } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
        [JENetWorking CreatePostUrl:API Param:param error:error];
        if (NetShowAct) {if (!--AllNetOperations) { [UIApplication sharedApplication].networkActivityIndicatorVisible = NO; }}
        if (Fai) {  Fai(task,error);return;}//æœ‰è‡ªå·±çš„å¤„ç†æ–¹å¼ è¿”å›žäº†
        if (task.error.code == NSURLErrorCancelled) {
            
        }else{
            [vc.HUD removeFromSuperview];
            if (vc) {
                ([JEApp.window.rootViewController ShowHUD:jekNetWorkERROR Img:-1 De:1.5]);
            }
        }
    }];
    
}

#pragma mark - å¤„ç†ç½‘ç»œè¯·æ±‚çš„å­—å…¸
+(void)HandleNetworkRes:(NSDictionary*)NetRes Op:(NSURLSessionDataTask *)operation Param:(NSDictionary*)param Vc:(UIViewController*)vc Suc:(void(^)(NSDictionary *Res))Suc{
    NSDictionary *data = NetRes[@"data"];
    QTZNetworkReturnCode code = [[NetRes str:@"code"] integerValue];
    
    if (code != QTZNetworkReturnCodeSuccess || data == nil) {//åæ­£ä¸æ˜¯æˆåŠŸ
        NSLog("\n%@\nâŒâŒâŒâŒ",[NSString stringWithFormat:@"%@",NetRes]);
        //è¦ä¸‹çº¿
        if ([@[@(QTZNetworkReturnCodeTokenWrong),@(QTZNetworkReturnCodeLoginTimeOut),@(QTZNetworkReturnCodeLoginConflict)] containsObject:@(code)] && JEApp.UserInfo != nil){
            [vc.AFM.operationQueue cancelAllOperations];
            [JENetWorking GameOver:code noti:[NetRes str:@"massage"]];
            return;
        }
        
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.5 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            Block_Exec(Suc,nil);//å¤±è´¥ è¿”å›ž nil
        });
        
        NSString *message = [NetRes str:@"massage"];
        //æ²¡GPSçš„æç¤º
        if (code == QTZNetworkReturnCodeNotGPSInfo) {
            [[[QTZ_AlertView alloc]initWithTitle:nil message:message.length ? message : @"è¯·å¼€å¯GPS\næŸ¥çœ‹é™„è¿‘æœåŠ¡å•†å®¶" buttonTitles:@[@"å–æ¶ˆ",@"å¼€å¯"]] showWithCompletion:^(int index) {
                if (index == 1) {
                    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:iOS10 ? UIApplicationOpenSettingsURLString : @"prefs:root=LOCATION_SERVICES"]];
                }
            }];
            return;
        }
        //å¼ºåˆ¶å‡çº§
        else if (code == QTZNetworkReturnCodeNeedToUpdate) {
            [JENetWorking needToUpdate:message];return;
        }
        
        if (vc) {
            [JEApp.window.rootViewController ShowHUD:message.length == 0 ? ([NSString stringWithFormat:@"æœåŠ¡å™¨ç¹å¿™!"]) : message Img:-1 De:2];
        }
        
        return;
    }
    
    if ([data isKindOfClass:[NSNull class]] || ([data isKindOfClass:[NSNumber class]] && [((NSNumber*)data) integerValue] == 0)) {
        data = nil;
    }
    
    Block_Exec(Suc,((data == nil) ? @{} : data));//æˆåŠŸè¿”å›ž ä¸æ˜¯nil
}


#pragma mark - æž„å»ºé”™è¯¯å†…å®¹ è¯·æ±‚å†…å®¹

+(void)CreatePostUrl:(NSString*)baseUrl Param:(NSDictionary*)param error:(NSError *)error{
#ifdef DEBUG
    NSLog(@"ðŸŒ \n\n%@\n%@\n\n",baseUrl,param.JsonStr);
    if (error) { NSLog(@"\n\n%@\n\n%@\n%@\nâŒâŒâŒâŒ",baseUrl,[error userInfo][@"NSErrorFailingURLKey"],[error userInfo][@"NSLocalizedDescription"]); }
#endif
}


/**  æ»šå›žåˆ°ç™»å½•ç•Œé¢  ï¼ˆç™»å½• å†²çª è¶…æ—¶ æç¤ºä¸‹çº¿ï¼‰ */
+ (void)GameOver:(QTZNetworkReturnCode)code noti:(NSString*)noti{
    [JEApp.window.rootViewController.AFM.operationQueue cancelAllOperations];
    [JEUserInfo LogOut_____];
    NSString *Psw = [USDF valueForKey:UserDef_AutoUserPassWord];
    BOOL isopenid = JEApp.UserInfo.openid.length != 0 ? YES : NO;
    
    if (code == QTZNetworkReturnCodeLoginConflict) {
        [[JEHandleCommon share] showAlertView:@"" Msg:noti cancleBtn:@"ç¡®å®š" otherBtn:@[@"é‡æ–°ç™»å½•"] completionBlock:^(int index) {
            if (index != 1) { return ;}
            LoginVC *vc = [[(UINavigationController*)JEApp.window.rootViewController viewControllers] firstObject];
            if (isopenid) {
                [vc WeiXinLogin:nil];return;
            }
            vc.Tf_Psw.text = Psw;
            [vc LoginClick:nil];
        }];
    }else{
        [USDF removeObjectForKey:UserDef_AutoUserPassWord];
    }
    
}


#pragma mark -  ä¸Šä¼ æµ  Data

+(void)uploadImg:(UIImage *)Loadimg AF:(AFHTTPSessionManager *)Manager VCPro:(UIViewController*)vc Pro:(void(^)(float Some,float All))progress Suc:(void(^)(NSDictionary *whether,NSString *path))success fail:(void(^)())failure{
    Manager.requestSerializer.timeoutInterval = 60;
    if (NetShowAct) {[UIApplication sharedApplication].networkActivityIndicatorVisible = YES; AllNetOperations++;}
    
    NSString *base64Str = [UIImageJPEGRepresentation(Loadimg,0.6) base64EncodedStringWithOptions:NSDataBase64EncodingEndLineWithLineFeed];
    NSData *data = [[NSString stringWithFormat:@"imgStr=%@&userId=%@",base64Str,JEApp.UserInfo.userId ? : @"system"] dataUsingEncoding:NSUTF8StringEncoding];
    
    NSMutableURLRequest *request = [[AFHTTPRequestSerializer serializer] multipartFormRequestWithMethod:@"POST" URLString:[NSString stringWithFormat:@"%@%@",BoJue_BASEHTTP,API_uploadImg] parameters:nil constructingBodyWithBlock:nil error:nil];
    [request setHTTPBody:data];
    
    Manager = [[AFHTTPSessionManager alloc] initWithSessionConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration]];
    
    NSURLSessionUploadTask *uploadTask = [Manager uploadTaskWithStreamedRequest:request progress:^(NSProgress * _Nonnull uploadProgress) {
        if (progress) {
            progress(uploadProgress.completedUnitCount,uploadProgress.totalUnitCount);
        }
    } completionHandler:^(NSURLResponse * _Nonnull response, NSDictionary *Get, NSError * _Nullable error) {
        if (NetShowAct) {if (!--AllNetOperations) { [UIApplication sharedApplication].networkActivityIndicatorVisible = NO;}}
        if (error) {
            Block_Exec(failure);
        }
        NSString *path = @"";
        NSDictionary *Conent = Get[@"data"];
        if ([Conent isKindOfClass:[NSDictionary class]]) {
            path = Conent[@"url"] ? : @"";
        }
        
        if (![Conent isKindOfClass:[NSDictionary class]] || Conent[@"url"] == nil) {
            if (failure) {
                failure();
            }else{
                [vc ShowHUD:@"æœåŠ¡å™¨ç¹å¿™" Img:0 De:1];
            }
            return ;
        }
        success(Get,path);
    }];
    
    [uploadTask resume];
    
}



#pragma mark - å¾®ä¿¡ç™»é™†

+(void)WeChatLogin:(NSString *)code result:(void(^)(NSDictionary *GetDic))result failure:(void(^)())failure{
    NSString *api  = [NSString stringWithFormat:@"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%@&secret=%@&code=%@&grant_type=authorization_code",
                      kWXAppID,
                      kweAppSecret,
                      code];
    [JEApp.window.rootViewController.AFM GET:api parameters:nil success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
        NSDictionary *GetDic = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableContainers error:nil];
        NSString *api2 = [NSString stringWithFormat:@"https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=%@&grant_type=refresh_token&refresh_token=%@",
                          kWXAppID,
                          GetDic[@"refresh_token"]];
        
        [JEApp.window.rootViewController.AFM GET:api2  parameters:nil success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
            NSDictionary *GetDic2 = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableContainers error:nil];
            NSString *api3 = [NSString stringWithFormat:@"https://api.weixin.qq.com/sns/userinfo?access_token=%@&openid=%@",GetDic2[@"access_token"],GetDic2[@"openid"]];
            
            [JEApp.window.rootViewController.AFM GET:api3 parameters:nil success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
                NSDictionary *GetDic3 = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableContainers error:nil];
                result(GetDic3);
                
            } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
                failure();
            }];
        } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
            failure();
        }];
    } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
        failure();
    }];
    
}

/** åŽå°åˆ·æ–°token refreshToken */
+ (void)refreshTokenInBackground{
    if (JEApp.UserInfo == nil || refreshingToken || AllNetOperations != 0) {  return; }
    //æ²¡å…¶ä»–è¯·æ±‚ && è¶…è¿‡7/2å¤©äº† åˆ·æ–°ä¸€ä¸‹token
    NSDate *lastTime = [USDF valueForKey:UserDef_refreshTokenTime];
    
    if (lastTime == nil || [[NSDate date] timeIntervalSinceDate:lastTime] > 24*60*60*3.5) {
        refreshingToken = YES;//æ€•ç½‘ç»œæ…¢çš„ è°ƒå‡ æ¬¡çš„ä¼šå‡ºé—®é¢˜
        [JENetWorking API:API_refreshToken Param:@{} Vc:nil AF:JEApp.window.rootViewController.AFM Suc:^(NSDictionary *Res) {
            if (JEApp.UserInfo) {
                [USDF setValue:[NSDate date] forKey:UserDef_refreshTokenTime];
                [USDF synchronize];
            }
            refreshingToken = NO;
        } Fai:nil];
    }
    
}

/** æ“Žå¤©åŠ©æ£€æŸ¥æ›´æ–° */
+ (void)QTZAppUpdate{
    if (JEApp.UserInfo == nil) {
        return;
    }
    
    [JEApp.window.rootViewController.AFM POST:[NSString stringWithFormat:@"%@%@",BoJue_BASEHTTP,API_updateApp] parameters:nil progress:nil success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
        NSDictionary *NetRes = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableContainers error:nil];
        NSDictionary *Res = NetRes[@"data"];
        if ([Res isKindOfClass:[NSNull class]] || ![Res isKindOfClass:[NSDictionary class]] || Res == nil) {
            return ;
        }
        if ([Tmbj_code integerValue] < [[Res str:@"versionCode"] integerValue]) {
            if ([[Res str:@"updateType"]integerValue] == 1) {//å¼ºåˆ¶å‡çº§
                [JENetWorking needToUpdate:[Res str:@"versionMsg"]];
            }
        }
    } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
        delay(2, ^{
            [self QTZAppUpdate];
        });
    }];
}

/** éœ€è¦æ›´æ–° */
+ (void)needToUpdate:(NSString*)msg{
    [[[QTZ_AlertView alloc]initWithTitle:@"å‡çº§æç¤º" message:msg buttonTitles:@[@"å–æ¶ˆ",@"å‰å¾€æ›´æ–°"]] showWithCompletion:^(int index) {
        if (index == 1) {
            [[UIApplication sharedApplication] openURL:[NSString stringWithFormat:@"itms-apps://itunes.apple.com/app/id%@",AppleStoreID].url];
        }
    }];
    
    [JEApp.window.rootViewController.AFM.operationQueue cancelAllOperations];
    [JEUserInfo LogOut_____];
}

@end
